<!DOCTYPE html>
<html
  lang="es"
  xmlns:th="http://www.thymeleaf.org"
  th:replace="~{_layout :: html(~{::title}, ~{::section}, ~{::pageCss}, ~{::pageScript})}">
  <head>
    <title th:text="${pageTitle ?: 'Detalle de Serie - WatchList'}">
      Detalle de Serie
    </title>
    <th:block th:fragment="pageCss">
      <link
        rel="stylesheet"
        th:href="@{/css/componentes/serie-detalle.css}" /> 
      <link rel="stylesheet" th:href="@{/css/componentes/tarjetas.css}" />
      <link rel="stylesheet" th:href="@{/css/componentes/comentarios.css}" /> 
    </th:block>
  </head>
  <body>
    <section th:fragment="section">
      <div
        class="content-container serie-detalle-container" 
        th:if="${serie != null}">
        <div class="pelicula-detalle-header">
          <h1 th:text="${serie.titulo}" class="page-title">
            Título de la Serie
          </h1>
          <span
            class="pelicula-detalle-anio"
            th:if="${serie.anioEstreno != null}">
            <span th:text="${serie.anioEstreno}">Año de Estreno</span>
            <span
              th:if="${serie.anioFin != null}"
              th:text="' - ' + ${serie.anioFin}"></span>
            <span
              th:if="${serie.anioFin == null}"
              th:text="' - Presente'"></span>
          </span>
          <div
            th:if="${serie.nTemporadas != null}"
            class="serie-detalle-temporadas">
            <span
              th:text="${serie.nTemporadas} + (${serie.nTemporadas == 1 ? ' Temporada' : ' Temporadas'})"></span>
          </div>
        </div>

        <div class="pelicula-detalle-main-content">
          <div class="pelicula-detalle-poster-container">
            <div
              class="poster-rating-badge"
              th:if="${serie.puntuacion != null}">
              <span
                class="rating-number"
                th:text="${#numbers.formatDecimal(serie.puntuacion, 1, 1)}"
                >0.0</span
              >
            </div>

            <img
              th:if="${serie.urlImagen != null and not #strings.isEmpty(serie.urlImagen)}"
              th:src="${serie.urlImagen}"
              th:alt="${serie.titulo}"
              class="pelicula-detalle-poster"
              loading="lazy" />
            <div
              th:unless="${serie.urlImagen != null and not #strings.isEmpty(serie.urlImagen)}"
              class="pelicula-detalle-poster-placeholder">
              <span>Sin Póster</span>
            </div>
          </div>

          <div class="pelicula-detalle-info">
            <div
              class="info-section"
              th:if="${not #lists.isEmpty(serie.creditos.?[rol != null and (#strings.equalsIgnoreCase(rol, 'creador') or #strings.equalsIgnoreCase(rol, 'showrunner') or #strings.equalsIgnoreCase(rol, 'dirección'))])}">
              <h2>Creador(es) / Dirección</h2>
              <p>
                <span
                  th:each="credito, iterStat : ${serie.creditos.?[rol != null and (#strings.equalsIgnoreCase(rol, 'creador') or #strings.equalsIgnoreCase(rol, 'showrunner') or #strings.equalsIgnoreCase(rol, 'dirección'))]}">
                  <a
                    th:href="@{/gente/{id}(id=${credito.persona.id})}"
                    class="director-link"
                    th:text="${credito.persona.nombre}"
                    >Nombre Creador/Director</a
                  ><th:block th:if="${!iterStat.last}">, </th:block>
                </span>
              </p>
            </div>

            <div
              class="info-section"
              th:if="${not #lists.isEmpty(serie.generos)}">
              <h2>Géneros</h2>
              <p class="tag-list">
                <span
                  th:each="genero : ${serie.generos}"
                  class="tag"
                  th:text="${genero.nombre}"
                  >Género</span
                >
              </p>
            </div>

            <div
              class="info-section"
              th:if="${not #lists.isEmpty(serie.plataformas)}">
              <h2>Disponible en</h2>
              <p class="plataforma-icons-list">
                <span
                  th:each="plataforma : ${serie.plataformas}"
                  class="plataforma-icon">
                  <img
                    th:if="${plataforma.logo != null && !plataforma.logo.isEmpty()}"
                    th:src="@{${plataforma.logo}}"
                    th:alt="${plataforma.nombre}"
                    th:title="${plataforma.nombre}"
                    class="plataforma-logo-img" />
                  <span
                    th:if="${plataforma.logo == null || plataforma.logo.isEmpty()}"
                    th:text="${plataforma.nombre}"
                    class="plataforma-logo-fallback-text"></span>
                </span>
              </p>
            </div>
          </div>
        </div>

        <div
          class="info-section pelicula-detalle-sinopsis"
          th:if="${serie.sinopsis != null and not #strings.isEmpty(serie.sinopsis)}">
          <h2>Sinopsis</h2>
          <p th:text="${serie.sinopsis}">Descripción de la serie...</p>
        </div>
        <div
          class="info-section pelicula-detalle-cast"
          th:if="${not #lists.isEmpty(serie.creditos.?[rol != null and (#strings.equalsIgnoreCase(rol, 'actor') or #strings.equalsIgnoreCase(rol, 'actriz') or #strings.equalsIgnoreCase(rol, 'reparto'))])}">
          <h2>Reparto Principal</h2>

          <div class="card-grid actores-grid">
            <div
              class="content-card actor-card"
              th:each="credito : ${serie.creditos.?[rol != null and (#strings.equalsIgnoreCase(rol, 'actor') or #strings.equalsIgnoreCase(rol, 'actriz') or #strings.equalsIgnoreCase(rol, 'reparto')) and persona != null]}">
              <a
                th:href="@{/gente/{id}(id=${credito.persona.id})}"
                class="content-card-link"
                th:title="${credito.persona.nombre}">
                <div class="content-card-poster-container">
                  <img
                    th:if="${credito.persona.fotoUrl != null and not #strings.isEmpty(credito.persona.fotoUrl)}"
                    th:src="${credito.persona.fotoUrl}"
                    th:alt="${credito.persona.nombre}"
                    class="content-card-poster persona-card-poster"
                    loading="lazy" />
                  <div
                    th:unless="${credito.persona.fotoUrl != null and not #strings.isEmpty(credito.persona.fotoUrl)}"
                    class="content-card-poster-placeholder">
                    <span>Sin Foto</span>
                  </div>
                </div>
                <div class="content-card-info actor-card-info">
                  <h3
                    class="content-card-title"
                    th:text="${credito.persona.nombre}">
                    Nombre del Actor
                  </h3>
                  <p
                    class="content-card-character"
                    th:if="${credito.personaje != null and not #strings.isEmpty(credito.personaje)}"
                    th:text="${credito.personaje}">
                    Personaje
                  </p>
                </div>
              </a>
            </div>
          </div>
        </div>

        <!-- ****** INICIO: Sección para Añadir a Lista ****** -->
        <div
          th:if="${session.usuarioId != null and misListas != null}"
          class="add-to-list-section info-section">
          <h2>Añadir a Mis Listas</h2>

          <div th:if="${misListas.isEmpty()}" class="mt-2">
            <p>
              No tienes listas creadas.
              <a
                th:href="@{/listas/nueva}"
                class="btn btn-sm btn-outline-primary"
                >Crea una lista primero</a
              >.
            </p>
          </div>

          <form
            th:unless="${misListas.isEmpty()}"
            th:action="@{/listas/{listaId}/media/{mediaId}/agregar(mediaId=${serie.id}, listaId='__LISTA_ID__')}"
            method="post"
            id="addToListFormSerie"
            class="form-inline mt-2">
            <div class="form-group mr-2 mb-2">
              <label for="listaSeleccionadaSerie" class="sr-only"
                >Selecciona una lista:</label
              >
              <select
                id="listaSeleccionadaSerie"
                name="listaId"
                class="form-control form-control-sm"
                required>
                <option value="" disabled selected>
                  Selecciona una lista...
                </option>
                <option
                  th:each="lista : ${misListas}"
                  th:value="${lista.id}"
                  th:text="${lista.titulo}">
                  Nombre de la Lista
                </option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary btn-sm mb-2">
              Añadir a Lista
            </button>
          </form>
          <!-- TODO mover a js dedicado -->
          <script th:inline="javascript" class="dynamic-script">
            const formSerie = document.getElementById("addToListFormSerie");
            console.log("Script loaded. formSerie element:", formSerie);

            if (formSerie) {
              const selectSerie = document.getElementById(
                "listaSeleccionadaSerie"
              );
              console.log("selectSerie element:", selectSerie);

              if (!selectSerie) {
                console.error(
                  "CRITICAL: Elemento select con ID 'listaSeleccionadaSerie' no encontrado."
                );
              } else {
                formSerie.addEventListener("submit", function (event) {
                  console.log(
                    "--- Form submit event triggered for addToListFormSerie ---"
                  );
                  event.preventDefault();
                  console.log("Default form submission prevented.");

                  const selectedValue = selectSerie.value;
                  console.log(
                    "Selected list ID (selectSerie.value):",
                    selectedValue
                  );

                  if (selectedValue && selectedValue !== "") {
                    let originalAction = formSerie.getAttribute("action");
                    console.log(
                      "Original form action from getAttribute:",
                      originalAction
                    );
                    const placeholder = "LISTA_ID";

                    if (originalAction.includes(placeholder)) {
                      let newAction = originalAction.replace(
                        placeholder,
                        selectedValue
                      );
                      console.log("New form action after replace:", newAction);

                      formSerie.setAttribute("action", newAction);
                      console.log(
                        "Form action after setAttribute (formSerie.action):",
                        formSerie.action
                      );
                      console.log(
                        "Form action after setAttribute (getAttribute):",
                        formSerie.getAttribute("action")
                      );

                      console.log(
                        "Attempting to submit form programmatically..."
                      );
                      formSerie.submit();
                    } else {
                      console.error(
                        "CRITICAL: Placeholder '" +
                          placeholder +
                          "' not found in original action URL:",
                        originalAction
                      );
                      alert(
                        "Error de configuración del formulario. No se pudo actualizar la URL."
                      );
                    }
                  } else {
                    alert("Por favor, selecciona una lista.");
                    console.log(
                      "List not selected, alert shown. Form not submitted."
                    );
                  }
                });
                console.log("Submit event listener attached to formSerie.");
              }
            } else {
              console.error(
                "CRITICAL: Formulario con ID 'addToListFormSerie' no encontrado al cargar el script."
              );
            }
          </script>
        </div>
        <!-- ****** FIN: Sección para Añadir a Lista ****** -->


        <!-- ****** INICIO: Sección para Mostrar Comentarios Existentes ****** -->
        <div class="info-section comentarios-section">
          <h2>Comentarios</h2>
          <div th:if="${exitoComentario}" class="comentario-mensaje comentario-mensaje-exito">
            <span th:text="${exitoComentario}"></span>
          </div>
          <div th:if="${errorComentario}" class="comentario-mensaje comentario-mensaje-error">
            <span th:text="${errorComentario}"></span>
          </div>

          <div th:if="${#lists.isEmpty(comentarios)}" class="comentarios-vacio-mensaje">
            <p>Aún no hay comentarios para esta serie. ¡Sé el primero!</p>
          </div>
          <ul th:unless="${#lists.isEmpty(comentarios)}" class="comentarios-list">
            <li th:each="comentario : ${comentarios}" class="comentario-item">
              <div class="comentario-header">
                <strong th:text="${comentario.usuario.nombre}" class="comentario-usuario">Usuario</strong>
                <span class="comentario-fecha" th:text="${#temporals.format(comentario.fecha, 'dd MMM yyyy, HH:mm')}">Fecha</span>
              </div>
              <div class="comentario-puntuacion">
                <span th:each="i : ${#numbers.sequence(1, 5)}"
                      class="star"
                      th:classappend="${i <= comentario.puntuacion ? 'filled' : ''}">&#9733;</span>
                <span class="sr-only" th:text="${comentario.puntuacion} + '/5'"></span>
              </div>
              <p th:text="${comentario.texto}" class="comentario-texto"></p>
            </li>
          </ul>
        </div>
        <!-- ****** FIN: Sección para Mostrar Comentarios Existentes ****** -->


        <!-- ****** INICIO: Formulario para Añadir Nuevo Comentario ****** -->
        <div th:if="${session.usuarioId != null}" class="info-section nuevo-comentario-section">
          <h2>Deja tu Comentario</h2>
          <form th:action="@{/serie/{serieId}/comentar(serieId=${serie.id})}"
                method="post"
                th:object="${nuevoComentario}">
                
            <div>
              <label for="comentarioTextoSerie">Tu opinión:</label> 
              <textarea id="comentarioTextoSerie" th:field="*{texto}" rows="4" required="required" th:value="${textoPrevio ?: ''}"></textarea>
              <div th:if="${#fields.hasErrors('texto')}" class="field-error">
                  <p th:each="err : ${#fields.errors('texto')}" th:text="${err}"></p>
              </div>
            </div>

            <div class="form-rating-group">
              <label for="starSerie1">Puntuación (1-5):</label> 
              <div class="rating-stars">
                  <input type="radio" id="starSerie5" name="puntuacion" value="5" th:field="*{puntuacion}" th:checked="${puntuacionPrevia == 5}"/><label for="starSerie5" title="5 estrellas">&#9733;</label>
                  <input type="radio" id="starSerie4" name="puntuacion" value="4" th:field="*{puntuacion}" th:checked="${puntuacionPrevia == 4}"/><label for="starSerie4" title="4 estrellas">&#9733;</label>
                  <input type="radio" id="starSerie3" name="puntuacion" value="3" th:field="*{puntuacion}" th:checked="${puntuacionPrevia == 3}"/><label for="starSerie3" title="3 estrellas">&#9733;</label>
                  <input type="radio" id="starSerie2" name="puntuacion" value="2" th:field="*{puntuacion}" th:checked="${puntuacionPrevia == 2}"/><label for="starSerie2" title="2 estrellas">&#9733;</label>
                  <input type="radio" id="starSerie1" name="puntuacion" value="1" th:field="*{puntuacion}" th:checked="${puntuacionPrevia == 1 ?: (nuevoComentario.puntuacion == null)}"/><label for="starSerie1" title="1 estrella">&#9733;</label>
              </div>
              <div th:if="${#fields.hasErrors('puntuacion')}" class="field-error">
                  <p th:each="err : ${#fields.errors('puntuacion')}" th:text="${err}"></p>
              </div>
            </div>
            <button type="submit" class="btn btn-green">Enviar Comentario</button>
          </form>
        </div>
        <div th:unless="${session.usuarioId != null}" class="info-section comentario-login-mensaje">
            <p>Debes <a th:href="@{/login(redirectUrl=${#httpServletRequest != null ? #httpServletRequest.requestURI : '/series'})}">iniciar sesión</a> para dejar un comentario.</p>
        </div>
        <!-- ****** FIN: Formulario para Añadir Nuevo Comentario ****** -->

      </div>
      <div th:if="${serie == null}" class="content-container">
        <p class="mensaje-no-encontrado">
          Serie no encontrada.
        </p>
      </div>
    </section>
    <th:block th:fragment="pageScript">
    </th:block>
  </body>
</html>
